{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "86e0736a",
   "metadata": {},
   "outputs": [],
   "source": [
    "#!pip install pyod"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "c1d2a2b7",
   "metadata": {},
   "outputs": [],
   "source": [
    "import pandas as pd\n",
    "from sklearn.model_selection import train_test_split\n",
    "import numpy as np\n",
    "#import random\n",
    "import matplotlib.pyplot as plt\n",
    "from tensorflow.keras import backend as k\n",
    "from pyod.utils.data import generate_data\n",
    "from pyod.models.auto_encoder import AutoEncoder\n",
    "import json\n",
    "#from keras.utils import plot_model"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "4f1a233c",
   "metadata": {},
   "outputs": [],
   "source": [
    "df = pd.read_csv(\"Normalized_df.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "81e6310f",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Encoder_Model = AutoEncoder(hidden_neurons =[128, 64, 32, 64, 128], epochs = 10,l2_regularizer = 0.01, dropout_rate = 0.05, contamination = 0.1, validation_size = 0.)\n",
    "# Encoder_Model.fit(df.loc[(df['Year'] >= 2016) & (df['Year'] <= 2018)][:10000])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "4d3abcde",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Specify search space\n",
    "epochsList = [50]\n",
    "hidden_neuronsList = [[128, 64, 32, 64, 128],[64, 32, 16, 32, 64]]\n",
    "dropout_rateList = [0.05]\n",
    "l2_regularizerList = [0.01, 0.001]\n",
    "contaminationList = [0.1]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "8307d11b",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Specify search space\n",
    "epochsList = [50]\n",
    "hidden_neuronsList = [[128, 64, 32, 64, 128]]\n",
    "dropout_rateList = [0.05]\n",
    "l2_regularizerList = [0.001]\n",
    "contaminationList = [0.1]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "4766d1b7",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "{'Model_1': {'epochs': 50, 'hidden_neurons': [128, 64, 32, 64, 128], 'dropout_rate': 0.05, 'l2_regularizer': 0.001, 'contamination': 0.1}}\n"
     ]
    }
   ],
   "source": [
    "# Construct dictionary associated with search space\n",
    "SearchSpaceDict = {}\n",
    "cnt = 1\n",
    "for epochs in epochsList:\n",
    "    for hidden_neurons in hidden_neuronsList:\n",
    "        for dropout_rate in dropout_rateList:\n",
    "            for l2_regularizer in l2_regularizerList:\n",
    "                for contamination in contaminationList:\n",
    "                    SearchSpaceDict[\"Model_{}\".format(str(cnt))] = {\"epochs\":epochs, \n",
    "                                                                    \"hidden_neurons\":hidden_neurons, \n",
    "                                                                    \"dropout_rate\":dropout_rate, \n",
    "                                                                    \"l2_regularizer\":l2_regularizer, \n",
    "                                                                    \"contamination\":contamination\n",
    "                                                                    }\n",
    "                    cnt = cnt + 1\n",
    "print(SearchSpaceDict)\n",
    "with open(\"SearchSpaceDict.json\", \"w\") as outfile: \n",
    "    json.dump(SearchSpaceDict, outfile)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "c42bb189",
   "metadata": {
    "scrolled": false
   },
   "outputs": [],
   "source": [
    "# ###################################################\n",
    "# # Run all models associated with the search space #\n",
    "# ###################################################\n",
    "# ModelResults = {}\n",
    "# # Iterate through search space dictionary\n",
    "# for CurModelKey in SearchSpaceDict.keys():\n",
    "#     #try:\n",
    "#     ModelResults[CurModelKey] = {'input_parameters':SearchSpaceDict[CurModelKey], \n",
    "#                                  'model':AutoEncoder(epochs = SearchSpaceDict[CurModelKey][\"epochs\"], \n",
    "#                                                      hidden_neurons = SearchSpaceDict[CurModelKey][\"hidden_neurons\"], \n",
    "#                                                      dropout_rate = SearchSpaceDict[CurModelKey][\"dropout_rate\"], \n",
    "#                                                      l2_regularizer = SearchSpaceDict[CurModelKey][\"l2_regularizer\"], \n",
    "#                                                      contamination = SearchSpaceDict[CurModelKey][\"contamination\"],\n",
    "#                                                      validation_size = 0., batch_size = 32)\n",
    "#                                 }\n",
    "#     ModelResults[CurModelKey]['model'].fit(df.loc[(df['Year'] >= 2016) & (df['Year'] <= 2018)])\n",
    "#     ModelResults[CurModelKey]['output'] = ModelResults[CurModelKey]['model'].history_[\"loss\"][-1]\n",
    "#     ModelResults[CurModelKey]['model'].model_.save(CurModelKey)\n",
    "#     #except:\n",
    "#     #    print(\"no\")\n",
    "#     #    pass"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "def5c5f5",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Model: \"sequential\"\n",
      "_________________________________________________________________\n",
      "Layer (type)                 Output Shape              Param #   \n",
      "=================================================================\n",
      "dense (Dense)                (None, 673)               453602    \n",
      "_________________________________________________________________\n",
      "dropout (Dropout)            (None, 673)               0         \n",
      "_________________________________________________________________\n",
      "dense_1 (Dense)              (None, 673)               453602    \n",
      "_________________________________________________________________\n",
      "dropout_1 (Dropout)          (None, 673)               0         \n",
      "_________________________________________________________________\n",
      "dense_2 (Dense)              (None, 128)               86272     \n",
      "_________________________________________________________________\n",
      "dropout_2 (Dropout)          (None, 128)               0         \n",
      "_________________________________________________________________\n",
      "dense_3 (Dense)              (None, 64)                8256      \n",
      "_________________________________________________________________\n",
      "dropout_3 (Dropout)          (None, 64)                0         \n",
      "_________________________________________________________________\n",
      "dense_4 (Dense)              (None, 32)                2080      \n",
      "_________________________________________________________________\n",
      "dropout_4 (Dropout)          (None, 32)                0         \n",
      "_________________________________________________________________\n",
      "dense_5 (Dense)              (None, 64)                2112      \n",
      "_________________________________________________________________\n",
      "dropout_5 (Dropout)          (None, 64)                0         \n",
      "_________________________________________________________________\n",
      "dense_6 (Dense)              (None, 128)               8320      \n",
      "_________________________________________________________________\n",
      "dropout_6 (Dropout)          (None, 128)               0         \n",
      "_________________________________________________________________\n",
      "dense_7 (Dense)              (None, 673)               86817     \n",
      "=================================================================\n",
      "Total params: 1,101,061\n",
      "Trainable params: 1,101,061\n",
      "Non-trainable params: 0\n",
      "_________________________________________________________________\n",
      "None\n",
      "Epoch 1/50\n",
      "9200/9200 [==============================] - 50s 5ms/step - loss: 38.4970\n",
      "Epoch 2/50\n",
      "9200/9200 [==============================] - 50s 5ms/step - loss: 32.1904\n",
      "Epoch 3/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 27.5896\n",
      "Epoch 4/50\n",
      "9200/9200 [==============================] - 50s 5ms/step - loss: 23.5671\n",
      "Epoch 5/50\n",
      "9200/9200 [==============================] - 50s 5ms/step - loss: 19.4449\n",
      "Epoch 6/50\n",
      "9200/9200 [==============================] - 48s 5ms/step - loss: 15.7882\n",
      "Epoch 7/50\n",
      "9200/9200 [==============================] - 48s 5ms/step - loss: 13.0210\n",
      "Epoch 8/50\n",
      "9200/9200 [==============================] - 49s 5ms/step - loss: 10.6302\n",
      "Epoch 9/50\n",
      "9200/9200 [==============================] - 49s 5ms/step - loss: 8.3938\n",
      "Epoch 10/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 5.9880\n",
      "Epoch 11/50\n",
      "9200/9200 [==============================] - 53s 6ms/step - loss: 4.4568\n",
      "Epoch 12/50\n",
      "9200/9200 [==============================] - 49s 5ms/step - loss: 3.2471\n",
      "Epoch 13/50\n",
      "9200/9200 [==============================] - 50s 5ms/step - loss: 2.3659\n",
      "Epoch 14/50\n",
      "9200/9200 [==============================] - 49s 5ms/step - loss: 1.7366\n",
      "Epoch 15/50\n",
      "9200/9200 [==============================] - 53s 6ms/step - loss: 1.4480\n",
      "Epoch 16/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 1.1976\n",
      "Epoch 17/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 1.1521\n",
      "Epoch 18/50\n",
      "9200/9200 [==============================] - 50s 5ms/step - loss: 1.3323\n",
      "Epoch 19/50\n",
      "9200/9200 [==============================] - 50s 5ms/step - loss: 3.8411\n",
      "Epoch 20/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 3.4223\n",
      "Epoch 21/50\n",
      "9200/9200 [==============================] - 53s 6ms/step - loss: 3.9370\n",
      "Epoch 22/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 3.3956\n",
      "Epoch 23/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 3.6404\n",
      "Epoch 24/50\n",
      "9200/9200 [==============================] - 54s 6ms/step - loss: 3.1227\n",
      "Epoch 25/50\n",
      "9200/9200 [==============================] - 53s 6ms/step - loss: 4.7806\n",
      "Epoch 26/50\n",
      "9200/9200 [==============================] - 53s 6ms/step - loss: 4.0651\n",
      "Epoch 27/50\n",
      "9200/9200 [==============================] - 53s 6ms/step - loss: 3.3200\n",
      "Epoch 28/50\n",
      "9200/9200 [==============================] - 52s 6ms/step - loss: 2.9460\n",
      "Epoch 29/50\n",
      "9200/9200 [==============================] - 53s 6ms/step - loss: 6.0814\n",
      "Epoch 30/50\n",
      "9200/9200 [==============================] - 52s 6ms/step - loss: 4.7335\n",
      "Epoch 31/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 4.0392\n",
      "Epoch 32/50\n",
      "9200/9200 [==============================] - 52s 6ms/step - loss: 3.2591\n",
      "Epoch 33/50\n",
      "9200/9200 [==============================] - 52s 6ms/step - loss: 6.2766\n",
      "Epoch 34/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 5.2918\n",
      "Epoch 35/50\n",
      "9200/9200 [==============================] - 51s 5ms/step - loss: 10.0939\n",
      "Epoch 36/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 8.8073\n",
      "Epoch 37/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 9.0020\n",
      "Epoch 38/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 9.8303\n",
      "Epoch 39/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 8.3557\n",
      "Epoch 40/50\n",
      "9200/9200 [==============================] - 51s 5ms/step - loss: 8.4503\n",
      "Epoch 41/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 7.4999\n",
      "Epoch 42/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 6.1690\n",
      "Epoch 43/50\n",
      "9200/9200 [==============================] - 51s 5ms/step - loss: 5.3342\n",
      "Epoch 44/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 4.5877\n",
      "Epoch 45/50\n",
      "9200/9200 [==============================] - 50s 5ms/step - loss: 6.6207\n",
      "Epoch 46/50\n",
      "9200/9200 [==============================] - 54s 6ms/step - loss: 5.5792\n",
      "Epoch 47/50\n",
      "9200/9200 [==============================] - 52s 6ms/step - loss: 5.2465\n",
      "Epoch 48/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 4.5155\n",
      "Epoch 49/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 3.6399\n",
      "Epoch 50/50\n",
      "9200/9200 [==============================] - 51s 6ms/step - loss: 3.4356\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "AutoEncoder(batch_size=32, contamination=0.1, dropout_rate=0.05, epochs=50,\n",
       "      hidden_activation='relu', hidden_neurons=[128, 64, 32, 64, 128],\n",
       "      l2_regularizer=0.001,\n",
       "      loss=<function mean_squared_error at 0x0000023F83D02A60>,\n",
       "      optimizer='adam', output_activation='sigmoid', preprocessing=True,\n",
       "      random_state=None, validation_size=0.0, verbose=1)"
      ]
     },
     "execution_count": 9,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Train the best model\n",
    "# m = np.inf\n",
    "# for key in ModelResults.keys():\n",
    "#     if ModelResults[key]['output'] < m:\n",
    "#         k = key\n",
    "#         m = ModelResults[key]['output']\n",
    "# print(\"BEST MODEL: \" + k)\n",
    "k = 'Model_1'\n",
    "        \n",
    "Encoder_Model = AutoEncoder(epochs = SearchSpaceDict[k][\"epochs\"],\n",
    "                            hidden_neurons = SearchSpaceDict[k][\"hidden_neurons\"],\n",
    "                            dropout_rate = SearchSpaceDict[k][\"dropout_rate\"],\n",
    "                            l2_regularizer = SearchSpaceDict[k][\"l2_regularizer\"], \n",
    "                            contamination = SearchSpaceDict[k][\"contamination\"],\n",
    "                            validation_size = 0.,\n",
    "                            batch_size = 32\n",
    "                           )        \n",
    "        \n",
    "Encoder_Model.fit(df.loc[(df['Year'] >= 2016) & (df['Year'] <= 2018)])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "7d972dd3",
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "image/png": "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\n",
      "text/plain": [
       "<Figure size 432x288 with 1 Axes>"
      ]
     },
     "metadata": {
      "needs_background": "light"
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "train_scores = Encoder_Model.decision_scores_.copy()\n",
    "train_bins = []\n",
    "for i in range(0, 210, 10):\n",
    "    train_bins.append(i)\n",
    "for idx, score in enumerate(train_scores):\n",
    "    if score > 200:\n",
    "        train_scores[idx] = 200\n",
    "plt.hist(train_scores, bins=train_bins)  \n",
    "plt.title(\"Histogram\")\n",
    "plt.ylabel(\"Frequency\")\n",
    "plt.xlabel(\"Loss\")\n",
    "plt.savefig(\"Train.pdf\")\n",
    "plt.show()\n",
    "plt.close()\n",
    "del train_bins\n",
    "del train_scores"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "6ff6aa8d",
   "metadata": {},
   "outputs": [],
   "source": [
    "# count = 0\n",
    "# print(len(y_train_scores))\n",
    "# for i in y_train_scores:\n",
    "#     if i > 200:\n",
    "#         count += 1\n",
    "# print(count)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "e9dfc140",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Predict the anomaly scores\n",
    "y_test_scores = Encoder_Model.decision_function(df.loc[df['Year'] > 2018])  # outlier scores\n",
    "y_test_scores = pd.Series(y_test_scores) "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "043196ab",
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "image/png": "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\n",
      "text/plain": [
       "<Figure size 432x288 with 1 Axes>"
      ]
     },
     "metadata": {
      "needs_background": "light"
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "test_bins = []\n",
    "test_scores = y_test_scores.copy()\n",
    "for i in range(0, 210, 10):\n",
    "    test_bins.append(i)\n",
    "for idx, score in enumerate(test_scores):\n",
    "    if score > 200:\n",
    "        test_scores[idx] = 200\n",
    "plt.hist(test_scores, bins=test_bins)  \n",
    "plt.title(\"Histogram\")\n",
    "plt.ylabel(\"Frequency\")\n",
    "plt.xlabel(\"Loss\")\n",
    "plt.savefig(\"Test.pdf\")\n",
    "plt.show()\n",
    "plt.close()\n",
    "del test_bins\n",
    "del test_scores"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "46dbb367",
   "metadata": {},
   "outputs": [],
   "source": [
    "#Saving reconstruction errors for training and testing set\n",
    "y_train_scores = Encoder_Model.decision_scores_\n",
    "with open(\"y_train_scores.json\", \"w\") as outfile: \n",
    "    json.dump(y_train_scores.tolist(), outfile)\n",
    "with open(\"y_test_scores.json\", \"w\") as outfile: \n",
    "    json.dump(y_test_scores.tolist(), outfile)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "94967628",
   "metadata": {},
   "outputs": [],
   "source": [
    "#Opening the file containing reconstruction errors\n",
    "with open(\"y_test_scores.json\") as f:\n",
    "    rec_errors = json.load(f)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "6891219b",
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>trans_tracking_nbr</th>\n",
       "      <th>Year</th>\n",
       "      <th>min_age_oldest_driver</th>\n",
       "      <th>min_age_youngest_driver</th>\n",
       "      <th>min_cbr</th>\n",
       "      <th>min_cbr_insufficientcredit_ind</th>\n",
       "      <th>min_cbr_nohit_ind</th>\n",
       "      <th>min_cbrscore</th>\n",
       "      <th>min_chargeable13</th>\n",
       "      <th>min_chargeable45</th>\n",
       "      <th>...</th>\n",
       "      <th>operatorstatus_inactiveoperator</th>\n",
       "      <th>operatorstatus_nonoperator</th>\n",
       "      <th>operatorstatus_nan</th>\n",
       "      <th>relationship_civunion</th>\n",
       "      <th>relationship_domesticpartner</th>\n",
       "      <th>relationship_married</th>\n",
       "      <th>relationship_single</th>\n",
       "      <th>relationship_nan</th>\n",
       "      <th>operatorcount</th>\n",
       "      <th>percentile_rec_errors</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>90909845</td>\n",
       "      <td>2019</td>\n",
       "      <td>0.655242</td>\n",
       "      <td>0.073559</td>\n",
       "      <td>-1.003318</td>\n",
       "      <td>-0.176531</td>\n",
       "      <td>-0.113304</td>\n",
       "      <td>0.935884</td>\n",
       "      <td>0.680332</td>\n",
       "      <td>-0.303277</td>\n",
       "      <td>...</td>\n",
       "      <td>-0.049345</td>\n",
       "      <td>-0.149307</td>\n",
       "      <td>-0.013952</td>\n",
       "      <td>-0.016481</td>\n",
       "      <td>-0.061487</td>\n",
       "      <td>1.372892</td>\n",
       "      <td>-1.361077</td>\n",
       "      <td>-0.014038</td>\n",
       "      <td>0.528600</td>\n",
       "      <td>0.000003</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>91559625</td>\n",
       "      <td>2019</td>\n",
       "      <td>-0.376913</td>\n",
       "      <td>-0.126347</td>\n",
       "      <td>-0.962966</td>\n",
       "      <td>-0.176531</td>\n",
       "      <td>-0.113304</td>\n",
       "      <td>0.820705</td>\n",
       "      <td>-0.504462</td>\n",
       "      <td>-0.303277</td>\n",
       "      <td>...</td>\n",
       "      <td>-0.049345</td>\n",
       "      <td>-0.149307</td>\n",
       "      <td>-0.013952</td>\n",
       "      <td>-0.016481</td>\n",
       "      <td>-0.061487</td>\n",
       "      <td>1.372892</td>\n",
       "      <td>-1.361077</td>\n",
       "      <td>-0.014038</td>\n",
       "      <td>0.528600</td>\n",
       "      <td>0.000006</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>90994616</td>\n",
       "      <td>2019</td>\n",
       "      <td>-0.073338</td>\n",
       "      <td>-0.067551</td>\n",
       "      <td>-0.120074</td>\n",
       "      <td>-0.176531</td>\n",
       "      <td>-0.113304</td>\n",
       "      <td>0.504786</td>\n",
       "      <td>-0.504462</td>\n",
       "      <td>-0.303277</td>\n",
       "      <td>...</td>\n",
       "      <td>-0.049345</td>\n",
       "      <td>-0.149307</td>\n",
       "      <td>-0.013952</td>\n",
       "      <td>-0.016481</td>\n",
       "      <td>-0.061487</td>\n",
       "      <td>1.372892</td>\n",
       "      <td>-1.361077</td>\n",
       "      <td>-0.014038</td>\n",
       "      <td>0.528600</td>\n",
       "      <td>0.000008</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>99914543</td>\n",
       "      <td>2019</td>\n",
       "      <td>-0.619773</td>\n",
       "      <td>-0.161625</td>\n",
       "      <td>-0.120074</td>\n",
       "      <td>-0.176531</td>\n",
       "      <td>-0.113304</td>\n",
       "      <td>0.462005</td>\n",
       "      <td>0.680332</td>\n",
       "      <td>-0.303277</td>\n",
       "      <td>...</td>\n",
       "      <td>-0.049345</td>\n",
       "      <td>-0.149307</td>\n",
       "      <td>-0.013952</td>\n",
       "      <td>-0.016481</td>\n",
       "      <td>-0.061487</td>\n",
       "      <td>1.372892</td>\n",
       "      <td>-1.361077</td>\n",
       "      <td>-0.014038</td>\n",
       "      <td>0.528600</td>\n",
       "      <td>0.000011</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>91296468</td>\n",
       "      <td>2019</td>\n",
       "      <td>0.776672</td>\n",
       "      <td>0.050041</td>\n",
       "      <td>-0.568421</td>\n",
       "      <td>-0.176531</td>\n",
       "      <td>-0.113304</td>\n",
       "      <td>0.613383</td>\n",
       "      <td>-0.504462</td>\n",
       "      <td>-0.303277</td>\n",
       "      <td>...</td>\n",
       "      <td>-0.049345</td>\n",
       "      <td>-0.149307</td>\n",
       "      <td>-0.013952</td>\n",
       "      <td>-0.016481</td>\n",
       "      <td>-0.061487</td>\n",
       "      <td>1.372892</td>\n",
       "      <td>-1.361077</td>\n",
       "      <td>-0.014038</td>\n",
       "      <td>0.528600</td>\n",
       "      <td>0.000014</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>355551</th>\n",
       "      <td>137540519</td>\n",
       "      <td>2019</td>\n",
       "      <td>-1.287637</td>\n",
       "      <td>-0.279217</td>\n",
       "      <td>-0.936066</td>\n",
       "      <td>-0.176531</td>\n",
       "      <td>-0.113304</td>\n",
       "      <td>0.761470</td>\n",
       "      <td>1.865127</td>\n",
       "      <td>-0.303277</td>\n",
       "      <td>...</td>\n",
       "      <td>-0.049345</td>\n",
       "      <td>-0.149307</td>\n",
       "      <td>-0.013952</td>\n",
       "      <td>-0.016481</td>\n",
       "      <td>-0.061487</td>\n",
       "      <td>-0.789905</td>\n",
       "      <td>0.796782</td>\n",
       "      <td>-0.014038</td>\n",
       "      <td>0.528600</td>\n",
       "      <td>0.999986</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>355552</th>\n",
       "      <td>154527706</td>\n",
       "      <td>2020</td>\n",
       "      <td>0.048092</td>\n",
       "      <td>-0.067551</td>\n",
       "      <td>-0.104105</td>\n",
       "      <td>-0.176531</td>\n",
       "      <td>-0.113304</td>\n",
       "      <td>-1.693483</td>\n",
       "      <td>1.865127</td>\n",
       "      <td>-0.303277</td>\n",
       "      <td>...</td>\n",
       "      <td>-0.049345</td>\n",
       "      <td>-0.149307</td>\n",
       "      <td>-0.013952</td>\n",
       "      <td>-0.016481</td>\n",
       "      <td>-0.061487</td>\n",
       "      <td>-0.789905</td>\n",
       "      <td>0.796782</td>\n",
       "      <td>-0.014038</td>\n",
       "      <td>0.528600</td>\n",
       "      <td>0.999989</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>355553</th>\n",
       "      <td>169886732</td>\n",
       "      <td>2020</td>\n",
       "      <td>0.776672</td>\n",
       "      <td>-0.232180</td>\n",
       "      <td>-0.104105</td>\n",
       "      <td>-0.176531</td>\n",
       "      <td>-0.113304</td>\n",
       "      <td>-1.693483</td>\n",
       "      <td>-0.504462</td>\n",
       "      <td>-0.303277</td>\n",
       "      <td>...</td>\n",
       "      <td>-0.049345</td>\n",
       "      <td>-0.149307</td>\n",
       "      <td>-0.013952</td>\n",
       "      <td>-0.016481</td>\n",
       "      <td>-0.061487</td>\n",
       "      <td>0.651960</td>\n",
       "      <td>-0.641791</td>\n",
       "      <td>-0.014038</td>\n",
       "      <td>1.842391</td>\n",
       "      <td>0.999992</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>355554</th>\n",
       "      <td>112213697</td>\n",
       "      <td>2019</td>\n",
       "      <td>1.383821</td>\n",
       "      <td>-0.338013</td>\n",
       "      <td>0.026907</td>\n",
       "      <td>-0.176531</td>\n",
       "      <td>-0.113304</td>\n",
       "      <td>-1.693483</td>\n",
       "      <td>1.865127</td>\n",
       "      <td>-0.303277</td>\n",
       "      <td>...</td>\n",
       "      <td>-0.049345</td>\n",
       "      <td>-0.149307</td>\n",
       "      <td>-0.013952</td>\n",
       "      <td>-0.016481</td>\n",
       "      <td>-0.061487</td>\n",
       "      <td>0.291494</td>\n",
       "      <td>-0.282148</td>\n",
       "      <td>-0.014038</td>\n",
       "      <td>3.156182</td>\n",
       "      <td>0.999994</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>355555</th>\n",
       "      <td>101657511</td>\n",
       "      <td>2019</td>\n",
       "      <td>0.290952</td>\n",
       "      <td>-0.220421</td>\n",
       "      <td>1.224967</td>\n",
       "      <td>-0.176531</td>\n",
       "      <td>-0.113304</td>\n",
       "      <td>0.244811</td>\n",
       "      <td>-0.504462</td>\n",
       "      <td>-0.303277</td>\n",
       "      <td>...</td>\n",
       "      <td>-0.049345</td>\n",
       "      <td>-0.149307</td>\n",
       "      <td>-0.013952</td>\n",
       "      <td>-0.016481</td>\n",
       "      <td>-0.061487</td>\n",
       "      <td>0.651960</td>\n",
       "      <td>-0.641791</td>\n",
       "      <td>-0.014038</td>\n",
       "      <td>1.842391</td>\n",
       "      <td>0.999997</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>355556 rows  674 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "        trans_tracking_nbr  Year  min_age_oldest_driver  \\\n",
       "0                 90909845  2019               0.655242   \n",
       "1                 91559625  2019              -0.376913   \n",
       "2                 90994616  2019              -0.073338   \n",
       "3                 99914543  2019              -0.619773   \n",
       "4                 91296468  2019               0.776672   \n",
       "...                    ...   ...                    ...   \n",
       "355551           137540519  2019              -1.287637   \n",
       "355552           154527706  2020               0.048092   \n",
       "355553           169886732  2020               0.776672   \n",
       "355554           112213697  2019               1.383821   \n",
       "355555           101657511  2019               0.290952   \n",
       "\n",
       "        min_age_youngest_driver   min_cbr  min_cbr_insufficientcredit_ind  \\\n",
       "0                      0.073559 -1.003318                       -0.176531   \n",
       "1                     -0.126347 -0.962966                       -0.176531   \n",
       "2                     -0.067551 -0.120074                       -0.176531   \n",
       "3                     -0.161625 -0.120074                       -0.176531   \n",
       "4                      0.050041 -0.568421                       -0.176531   \n",
       "...                         ...       ...                             ...   \n",
       "355551                -0.279217 -0.936066                       -0.176531   \n",
       "355552                -0.067551 -0.104105                       -0.176531   \n",
       "355553                -0.232180 -0.104105                       -0.176531   \n",
       "355554                -0.338013  0.026907                       -0.176531   \n",
       "355555                -0.220421  1.224967                       -0.176531   \n",
       "\n",
       "        min_cbr_nohit_ind  min_cbrscore  min_chargeable13  min_chargeable45  \\\n",
       "0               -0.113304      0.935884          0.680332         -0.303277   \n",
       "1               -0.113304      0.820705         -0.504462         -0.303277   \n",
       "2               -0.113304      0.504786         -0.504462         -0.303277   \n",
       "3               -0.113304      0.462005          0.680332         -0.303277   \n",
       "4               -0.113304      0.613383         -0.504462         -0.303277   \n",
       "...                   ...           ...               ...               ...   \n",
       "355551          -0.113304      0.761470          1.865127         -0.303277   \n",
       "355552          -0.113304     -1.693483          1.865127         -0.303277   \n",
       "355553          -0.113304     -1.693483         -0.504462         -0.303277   \n",
       "355554          -0.113304     -1.693483          1.865127         -0.303277   \n",
       "355555          -0.113304      0.244811         -0.504462         -0.303277   \n",
       "\n",
       "        ...  operatorstatus_inactiveoperator  operatorstatus_nonoperator  \\\n",
       "0       ...                        -0.049345                   -0.149307   \n",
       "1       ...                        -0.049345                   -0.149307   \n",
       "2       ...                        -0.049345                   -0.149307   \n",
       "3       ...                        -0.049345                   -0.149307   \n",
       "4       ...                        -0.049345                   -0.149307   \n",
       "...     ...                              ...                         ...   \n",
       "355551  ...                        -0.049345                   -0.149307   \n",
       "355552  ...                        -0.049345                   -0.149307   \n",
       "355553  ...                        -0.049345                   -0.149307   \n",
       "355554  ...                        -0.049345                   -0.149307   \n",
       "355555  ...                        -0.049345                   -0.149307   \n",
       "\n",
       "        operatorstatus_nan  relationship_civunion  \\\n",
       "0                -0.013952              -0.016481   \n",
       "1                -0.013952              -0.016481   \n",
       "2                -0.013952              -0.016481   \n",
       "3                -0.013952              -0.016481   \n",
       "4                -0.013952              -0.016481   \n",
       "...                    ...                    ...   \n",
       "355551           -0.013952              -0.016481   \n",
       "355552           -0.013952              -0.016481   \n",
       "355553           -0.013952              -0.016481   \n",
       "355554           -0.013952              -0.016481   \n",
       "355555           -0.013952              -0.016481   \n",
       "\n",
       "        relationship_domesticpartner  relationship_married  \\\n",
       "0                          -0.061487              1.372892   \n",
       "1                          -0.061487              1.372892   \n",
       "2                          -0.061487              1.372892   \n",
       "3                          -0.061487              1.372892   \n",
       "4                          -0.061487              1.372892   \n",
       "...                              ...                   ...   \n",
       "355551                     -0.061487             -0.789905   \n",
       "355552                     -0.061487             -0.789905   \n",
       "355553                     -0.061487              0.651960   \n",
       "355554                     -0.061487              0.291494   \n",
       "355555                     -0.061487              0.651960   \n",
       "\n",
       "        relationship_single  relationship_nan  operatorcount  \\\n",
       "0                 -1.361077         -0.014038       0.528600   \n",
       "1                 -1.361077         -0.014038       0.528600   \n",
       "2                 -1.361077         -0.014038       0.528600   \n",
       "3                 -1.361077         -0.014038       0.528600   \n",
       "4                 -1.361077         -0.014038       0.528600   \n",
       "...                     ...               ...            ...   \n",
       "355551             0.796782         -0.014038       0.528600   \n",
       "355552             0.796782         -0.014038       0.528600   \n",
       "355553            -0.641791         -0.014038       1.842391   \n",
       "355554            -0.282148         -0.014038       3.156182   \n",
       "355555            -0.641791         -0.014038       1.842391   \n",
       "\n",
       "        percentile_rec_errors  \n",
       "0                    0.000003  \n",
       "1                    0.000006  \n",
       "2                    0.000008  \n",
       "3                    0.000011  \n",
       "4                    0.000014  \n",
       "...                       ...  \n",
       "355551               0.999986  \n",
       "355552               0.999989  \n",
       "355553               0.999992  \n",
       "355554               0.999994  \n",
       "355555               0.999997  \n",
       "\n",
       "[355556 rows x 674 columns]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "# Saving the dataset with reconstruction errors\n",
    "new_df = df.loc[df['Year'] > 2018].reset_index().drop('index', axis = 1)\n",
    "new_df['reconstruction_error'] = rec_errors\n",
    "new_df.sort_values('reconstruction_error', ascending = True, inplace = True, ignore_index = True)\n",
    "new_df['Index'] = [x for x in range(1, len(new_df) + 1)]\n",
    "new_df['percentile_rec_errors'] = new_df['Index']/(len(new_df)+1)\n",
    "del new_df['Index']\n",
    "del new_df['reconstruction_error']\n",
    "display(new_df)\n",
    "new_df.to_csv(\"Testing_with_errors.csv\", index = False)\n",
    "del new_df\n",
    "del rec_errors"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "619cd798",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.2"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
